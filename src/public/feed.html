<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="./feed.css">
    <title>Your Feed</title>
</head>
<body onload=fetch()>
    
    <div id="feed">
        <header>
            <label for="login">Logged as </label>
            <input id="username" disabled />
        </header>

        <div id="comments">

        </div>

        <div id="new">
            <input type="text" id="new-comment" />
            <button onclick=newComment() >Comment</button>
        </div>
    </div>

    <script type="text/javascript">
        let user_id = 0

        const params = location.search.substring(1).split("&")

        const username = params[0].split("=")[1]
        const password = params[1].split("=")[1]

        async function fetch() {        
            const url = `http://localhost:3333/users/${username}/${password}`

            axios.get(url).then(response => {
                console.log(response)
                user_id = response.data.id
                document.getElementById('username').value = username
            })
            getComments()
        }

        async function getComments(){
            const commentsUrl = `http://localhost:3333/comments`
            axios.get(commentsUrl).then(response => {
                response.data.map(comment => {
                    makeComment(comment)
                })
            })
        }

        function makeComment(comment){
            const div = document.createElement('div')
            div.classList.add('comment')

            const span = document.createElement('span')
            span.innerHTML = 
                `${comment.username}
                    <p>
                        ${comment.content}
                    </p>`
            div.append(span)
            document.getElementById("comments").append(div)
        }

        async function newComment() {
            const comment = document.getElementById('new-comment')
            const content = comment.value

            const commentsUrl = `http://localhost:3333/comments`
            axios.post(commentsUrl, {
                user_id,
                content
            }).then(data => {
                makeComment({
                    username,
                    content
                })
                comment.value = ""
            })
    }
    </script>
</body>
</html>